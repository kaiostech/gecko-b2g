#!/usr/bin/env python3

import json
import os

def generate(output, *input_paths):
    """
    This file generates a ThirdPartyPaths.cpp file from the ThirdPartyPaths.txt
    file in /tools/rewriting, which is used by the Clang Plugin to help identify
    sources which should be ignored.
    """
    tpp_list = []
    lines = set()

    for path in input_paths:
        with open(path) as f:
            lines.update(f.readlines())

    # Add the Gonk root path to the 3rd party list to prevent issues in the camera code.
    if 'GONK_PATH' in os.environ:
        GECKO_DIRS = ['gecko', 'objdir-gecko']
        for dir in os.listdir(path=os.environ['GONK_PATH']):
            fulldir = os.path.join(os.environ['GONK_PATH'], dir)
            if os.path.isdir(fulldir) and not dir in GECKO_DIRS:
                lines.add(fulldir)

    for line in lines:
        line = line.strip()
        if line.endswith('/'):
            line = line[:-1]
        tpp_list.append(line)
    tpp_strings = ',\n  '.join([json.dumps(tpp) for tpp in sorted(tpp_list)])

    output.write("""\
/* THIS FILE IS GENERATED BY ThirdPartyPaths.py - DO NOT EDIT */

#include <stdint.h>

const char* MOZ_THIRD_PARTY_PATHS[] = {
  %s
};

extern const uint32_t MOZ_THIRD_PARTY_PATHS_COUNT = %d;

""" % (tpp_strings, len(tpp_list)))
